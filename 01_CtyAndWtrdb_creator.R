# Name: 01_CtyAndWtrdb_creator.R
# Purpose: Convert Biotics Exports to SQLite DB
# Authors: Jordana Anderson, Chris Tracey, Cameron Scott
# Created: 2022-11-11
#
#---------------------------------------------------

rm(list=ls()) # clean environments

# Settings from Script 00
if (!requireNamespace("here", quietly=TRUE)) install.packages("here")
require(here)
#source(here::here("Automation_scripts", "00_PathsAndSettings_CtyWtr.r"))
source(here::here("00_PathsAndSettings_CtyWtr.r"))

# Make sure the output directories have been created:
ifelse(!dir.exists(here::here("_data")), dir.create(here::here("_data")), FALSE)
ifelse(!dir.exists(here::here("_data","output")), dir.create(here::here("_data","output")), FALSE)

########################
# Convert Biotics Exports to SQLite Databases
db <- dbConnect(SQLite(), dbname=databasename) # creates an empty database
dbDisconnect(db) # disconnect the db

# Load tables
county_table <- read.table(sourceCnty, header=TRUE, sep="\t")
watershed_table <- read.table(sourceWater, header=TRUE, sep="\t", colClasses=c("HUC8_CD"="character"))

# Write tables to sqlite db
db <- dbConnect(SQLite(), dbname=databasename) # connect to db
dbWriteTable(db, "county_table", county_table, overwrite=TRUE)
dbWriteTable(db, "watershed_table", watershed_table, overwrite=TRUE)
dbDisconnect(db) # disconnect the db

###########################
# add in NABA data?




## Set up driver info and database path
DRIVERINFO <- "Driver={Microsoft Access Driver (*.mdb, *.accdb)};"
nabaPATH <- "X:/ZOOLOGY/NABA Deliverables (Jan2020)/Crayfish-Fish-MusselsSpeciesHUC_2020Jan05.accdb"
channel <- odbcDriverConnect(paste0(DRIVERINFO, "DBQ=", nabaPATH))

## Load data into R dataframe
nabaTable <- sqlQuery(channel, "SELECT * FROM [Species-HUC];",stringsAsFactors=FALSE)
close(channel) ## Close and remove channel

## Testing Max's Code
## Connect to central biotics to pull out most recent data on sss
con<-odbcConnect("centralbiotics", uid="biotics_report", pwd=rstudioapi::askForPassword("Password"))

## Insert sql query
qry <- "select  egt.element_global_id,
  tg.parent_species_id,
  hdms.informal_tax(egt.element_global_id) major_subgroup1,
  hdms.nsx_informal_tax(egt.element_global_id) MAJOR_SUBGROUP2,
  egt.gname, 
  egt.g_primary_common_name g_comname,
  egt.g_rank,
  egt.rounded_g_rank,
  du.usesa_cd,
  tg.interpreted_usesa interpreted_usesa, 
  egt_usesa(egt.element_global_id) egt_usesa, 
  null max_obs_year,
  null rec_count,
  '' best_eo_rank,
  'NABA' occ_src,
  '' G1G2ORUSESA_ind,
  case
    when egt.rounded_g_rank in ('G1','G2') then 'Y'
    when exists (select 1 from hdms.element_global egt2, hdms.taxon_global tg2 
                 where tg2.element_global_id = egt.element_global_id
                   and egt2.element_global_id = tg2.parent_species_id
                   and egt2.rounded_g_rank in ('G1', 'G2')) then 'Y' 
    else null
  end g1g2_ind,
  '' ANYUSESA_IND,
  '' LE_IND,
  '' LT_IND,
  '' CANDPROP_IND,
  '' G1G2WOUSESA_IND,
  'https://explorer.natureserve.org/Taxon/ELEMENT_GLOBAL.' || egt.element_global_ou_uid || '.' || egt.element_global_seq_uid nsx_link
from hdms.element_global_dvw egt
   , hdms.taxon_global tg
   , hdms.d_usesa du
where egt.element_global_id = tg.element_global_id
  and tg.d_usesa_id = du.d_usesa_id (+)
  and (egt.element_global_id in (100003, 100009, 100029, 100033, 100039, 100058, 100067, 100088, 100119, 100127, 100130, 100138, 100151, 100152, 100166, 100168, 100184, 100230, 100235, 100241, 100250, 100254, 100258, 100269, 100273, 100279, 100282, 100287, 100314, 100335, 100338, 100366, 100367, 100368, 100373, 100378, 100380, 100382, 100391, 100403, 100418, 100431, 100432, 100434, 100436, 100441, 100470, 100500, 100519, 100524, 100526, 100544, 100557, 100559, 100562, 100564, 100567, 100568, 100574, 100579, 100581, 100601, 100631, 100641, 100654, 100679, 100687, 100689, 100691, 100707, 100708, 100712, 100713, 100715, 100745, 100747, 100752, 100762, 100771, 100776, 100778, 100781, 100798, 100799, 100808, 100817, 100819, 100824, 100831, 100843, 100857, 100872, 100890, 100892, 100902, 100929, 100934, 100935, 100938, 100947, 100951, 100954, 100956, 100965, 100974, 100986, 100992, 101042, 101058, 101067, 101069, 101072, 101074, 101080, 101083, 101084, 101085, 101089, 101090, 101092, 101097, 101121, 101141, 101159, 101168, 101185, 101187, 101201, 101205, 101215, 101220, 101227, 101234, 101250, 101272, 101279, 101298, 101299, 101314, 101315, 101317, 101328, 101339, 101354, 101360, 101361, 101364, 101366, 101374, 101378, 101382, 101391, 101436, 101449, 101469, 101481, 101488, 101492, 101507, 101518, 101522, 101529, 101538, 101542, 101547, 101548, 101561, 101564, 101565, 101569, 101577, 101592, 101593, 101603, 101620, 101622, 101653, 101654, 101672, 101697, 101698, 101703, 101716, 101723, 101737, 101754, 101756, 101764, 101767, 101772, 101786, 101796, 101809, 101820, 101847, 101865, 101870, 101871, 101878, 101884, 101893, 101895, 101911, 101918, 101946, 101948, 101968, 101974, 101978, 101984, 101985, 102003, 102006, 102010, 102018, 102047, 102051, 102057, 102072, 102081, 102084, 102092, 102101, 102102, 102103, 102115, 102136, 102137, 102151, 102158, 102165, 102174, 102176, 102201, 102202, 102216, 102235, 102239, 102259, 102265, 102267, 102313, 102317, 102329, 102340, 102350, 102359, 102361, 102364, 102365, 102368, 102380, 102383, 102384, 102395, 102400, 102402, 102411, 102418, 102442, 102450, 102451, 102455, 102490, 102491, 102496, 102499, 102508, 102511, 102532, 102538, 102540, 102551, 102552, 102561, 102566, 102587, 102592, 102595, 102599, 102603, 102630, 102650, 102667, 102701, 102702, 102706, 102707, 102709, 102713, 102719, 102725, 102735, 102738, 102739, 102766, 102785, 102786, 102787, 102803, 102805, 102806, 102837, 102838, 102842, 102846, 102848, 102858, 102864, 102894, 102911, 102912, 102920, 102923, 102927, 102929, 102932, 102933, 102960, 102975, 102977, 102978, 102980, 102984, 102985, 103005, 103006, 103021, 103033, 103047, 103055, 103079, 103081, 103094, 103100, 103103, 103112, 103119, 103133, 103134, 103136, 103143, 103158, 103159, 103168, 103172, 103179, 103184, 103190, 103219, 103221, 103223, 103226, 103234, 103235, 103271, 103289, 103310, 103351, 103361, 103370, 103380, 103387, 103389, 103390, 103391, 103434, 103436, 103442, 103444, 103452, 103461, 103471, 103498, 103506, 103525, 103551, 103565, 103578, 103583, 103584, 103598, 103602, 103616, 103624, 103652, 103660, 103671, 103679, 103687, 103689, 103693, 103696, 103697, 103698, 103701, 103711, 103713, 103717, 103718, 103760, 103789, 103800, 103808, 103813, 103831, 103832, 103841, 103862, 103873, 103888, 103897, 103898, 103900, 103914, 103917, 103945, 103954, 103958, 103959, 103970, 103972, 103974, 103976, 103988, 103990, 104010, 104017, 104021, 104035, 104049, 104050, 104060, 104071, 104072, 104082, 104083, 104088, 104090, 104091, 104110, 104136, 104138, 104145, 104147, 104179, 104185, 104191, 104192, 104195, 104197, 104223, 104226, 104232, 104244, 104252, 104253, 104274, 104284, 104286, 104287, 104297, 104303, 104308, 104309, 104310, 104321, 104334, 104339, 104345, 104354, 104380, 104382, 104388, 104403, 104404, 104407, 104413, 104414, 104422, 104435, 104444, 104453, 104457, 104463, 104464, 104465, 104481, 104485, 104489, 104518, 104519, 104520, 104524, 104525, 104547, 104549, 104554, 104555, 104556, 104567, 104572, 104606, 104632, 104633, 104658, 104659, 104661, 104669, 104696, 104698, 104700, 104715, 104716, 104717, 104718, 104724, 104731, 104743, 104745, 104768, 104769, 104770, 104776, 104778, 104779, 104785, 104786, 104788, 104822, 104840, 104841, 104843, 104855, 104857, 104867, 104871, 104875, 104876, 104886, 104889, 104894, 104896, 104901, 104903, 104906, 104908, 104913, 104933, 104951, 104957, 104976, 104990, 104996, 104997, 105009, 105016, 105028, 105029, 105031, 105033, 105040, 105048, 105051, 105058, 105060, 105065, 105068, 105071, 105133, 105140, 105151, 105164, 105179, 105184, 105188, 105191, 105194, 105211, 105219, 105221, 105223, 105230, 105244, 105248, 105258, 105271, 105278, 105283, 105294, 105295, 105318, 105319, 105333, 105334, 105342, 105359, 105367, 105369, 105373, 105382, 105384, 105403, 105416, 105421, 105429, 105433, 105437, 105438, 105474, 105489, 105491, 105496, 105498, 105502, 105504, 105506, 105508, 105509, 105517, 105531, 105547, 105553, 105559, 105573, 105579, 105581, 105585, 105595, 105596, 105598, 105605, 105614, 105624, 105626, 105633, 105635, 105654, 105662, 105669, 105674, 105680, 105689, 105690, 105691, 105693, 105699, 105704, 105718, 105723, 105726, 105728, 105729, 105739, 105741, 105743, 105747, 105774, 105784, 105789, 105800, 105802, 105804, 105811, 105815, 105818, 105819, 105820, 105821, 105828, 105832, 105833, 105843, 105844, 105846, 105858, 105859, 105862, 105875, 105887, 105890, 105897, 105904, 105907, 105908, 105913, 105916, 105944, 105947, 105948, 105949, 105952, 105958, 105965, 105972, 105986, 105987, 106003, 106014, 106021, 106027, 106031, 106034, 106037, 106038, 106044, 106051, 106053, 106055, 106063, 106067, 106085, 106091, 106104, 106106, 106108, 106109, 106113, 106117, 106123, 106124, 106128, 106145, 106148, 106151, 106152, 106161, 106174, 106187, 106188, 106189, 106190, 106200, 106206, 106208, 106210, 106213, 106214, 106227, 106252, 106259, 106268, 106278, 106293, 106303, 106304, 106307, 106308, 106309, 106310, 106322, 106336, 106337, 106340, 106356, 106358, 106371, 106387, 106393, 106396, 106404, 106405, 106421, 106423, 106437, 106441, 106443, 106464, 106479, 106498, 106513, 106516, 106521, 106522, 106525, 106551, 106552, 106566, 106567, 106572, 106576, 106577, 106578, 106584, 106631, 106652, 106695, 106741, 106747, 106760, 106826, 106842, 106855, 106894, 106952, 106982, 107042, 107062, 107076, 107100, 107140, 107168, 107204, 107251, 107275, 107304, 107322, 107339, 107352, 107377, 107397, 107398, 107416, 107419, 107426, 107473, 107561, 107605, 107684, 107700, 107701, 107752, 107777, 107788, 107814, 107836, 107905, 107915, 107931, 107932, 107950, 107980, 108019, 108156, 108188, 108198, 108206, 108231, 108233, 108236, 108301, 108324, 108359, 108402, 108462, 108498, 108526, 108563, 108604, 108607, 108648, 108654, 108680, 108685, 108689, 108690, 108712, 108724, 108882, 108909, 108924, 108931, 108941, 108966, 108975, 109105, 109111, 109125, 109142, 109254, 109267, 109289, 109290, 109292, 109309, 109325, 109353, 109368, 109373, 109413, 109483, 109494, 109620, 109623, 109629, 109635, 109648, 109663, 109664, 109677, 109708, 109711, 109746, 109774, 109839, 109848, 109863, 109882, 109895, 109938, 109950, 110016, 110054, 110077, 110090, 110094, 110125, 110129, 110159, 110240, 110321, 110459, 110462, 110472, 110475, 110500, 110514, 110535, 110545, 110562, 110563, 110585, 110614, 110617, 110625, 110675, 110730, 110798, 110816, 110918, 110993, 111035, 111051, 111053, 111054, 111058, 111059, 111102, 111123, 111126, 111144, 111150, 111327, 111413, 111433, 111436, 111437, 111519, 111544, 111554, 111565, 111603, 111623, 111670, 111672, 111679, 111680, 111681, 111694, 111695, 111740, 111783, 111787, 111793, 111912, 111916, 111921, 111959, 111980, 111981, 111988, 112006, 112021, 112022, 112023, 112045, 112048, 112049, 112056, 112061, 112130, 112143, 112227, 112249)
       or egt.element_global_id in (112282, 112294, 112351, 112361, 112393, 112404, 112499, 112501, 112524, 112531, 112560, 112611, 112669, 112700, 112706, 112722, 112731, 112734, 112735, 112792, 112824, 112835, 112853, 112886, 112888, 112927, 112938, 112939, 112995, 112997, 113003, 113013, 113016, 113038, 113071, 113192, 113228, 113278, 113295, 113327, 113370, 113403, 113406, 113439, 113470, 113582, 113595, 113633, 113655, 113659, 113722, 113749, 113759, 113778, 113786, 113787, 113788, 113789, 113791, 113805, 113811, 113818, 113819, 113868, 113870, 113878, 113936, 113961, 113991, 114207, 114210, 114327, 114359, 114415, 114437, 114495, 114498, 114533, 114560, 114561, 114573, 114597, 114603, 114607, 114609, 114612, 114639, 114652, 114659, 114676, 114679, 114692, 114703, 114706, 114744, 114749, 114853, 114892, 114949, 114962, 114975, 115007, 115020, 115056, 115060, 115069, 115105, 115165, 115180, 115192, 115209, 115217, 115224, 115241, 115372, 115405, 115424, 115425, 115431, 115433, 115455, 115496, 115565, 115566, 115572, 115601, 115603, 115610, 115611, 115707, 115775, 115806, 115810, 115819, 115823, 115905, 115946, 115959, 116006, 116035, 116038, 116048, 116059, 116061, 116085, 116088, 116097, 116132, 116158, 116169, 116207, 116208, 116226, 116252, 116272, 116283, 116284, 116313, 116326, 116350, 116351, 116397, 116435, 116472, 116486, 116497, 116511, 116516, 116648, 116696, 116734, 116758, 116795, 116817, 116858, 116872, 116875, 116882, 116898, 116903, 116918, 116943, 116944, 116970, 117051, 117056, 117057, 117061, 117064, 117066, 117070, 117079, 117120, 117121, 117134, 117135, 117159, 117188, 117214, 117215, 117227, 117282, 117283, 117298, 117302, 117311, 117320, 117329, 117443, 117448, 117491, 117497, 117516, 117578, 117599, 117603, 117633, 117640, 117674, 117693, 117697, 117705, 117708, 117714, 117716, 117733, 117740, 117784, 117786, 117824, 117840, 117847, 117864, 117933, 117973, 117974, 117975, 117994, 118019, 118054, 118056, 118123, 118132, 118136, 118149, 118150, 118167, 118191, 118212, 118225, 118229, 118231, 118288, 118293, 118335, 118336, 118338, 118367, 118395, 118421, 118422, 118492, 118496, 118506, 118525, 118527, 118536, 118603, 118702, 118738, 118740, 118762, 118837, 118840, 118846, 118891, 118902, 118984, 119032, 119033, 119039, 119053, 119078, 119084, 119144, 119181, 119192, 119203, 119209, 119332, 119336, 119337, 119338, 119424, 119426, 119469, 119501, 119523, 119524, 119538, 119543, 119585, 119588, 119646, 119668, 119673, 119782, 119787, 119823, 119840, 119870, 120030, 120051, 120096, 120101, 120120, 120124, 120149, 120163, 120183, 120256, 120267, 120294, 120402, 120469, 120471, 120493, 120496, 120536, 120537, 120551, 120552, 120557, 120564, 120607, 120608, 120609, 120629, 120661, 120679, 120691, 120697, 120713, 120715, 120730, 120783, 120784, 120789, 120814, 120868, 120989, 120990, 121035, 121049, 121064, 121112, 121124, 121170, 121255, 121272, 121294, 121301, 121313, 637195, 637255, 637266, 640697, 680054, 681170, 681172, 681173, 720843, 728749, 733110, 737474, 737546, 737553, 738825, 738886, 738920, 738924, 738954, 768556, 769113, 769114, 786001, 788163, 790349, 790433, 790442, 790457, 790461, 790464, 790468, 790513, 790518, 790801, 791021, 791112, 791391, 791402, 791411, 791450, 791464, 791466, 791584, 791585, 791631, 792569, 793651, 793723, 793726, 793729, 793732, 795183, 795348, 795352, 795355, 797126, 797129, 797927, 797928, 798252, 807582, 814563, 814575, 814735, 814750, 817900, 819864, 819868, 819914, 821051, 821052, 821244, 821661, 821665, 821672, 821675, 827176, 827178, 827181, 827412, 827419, 827431, 827809, 827817, 827823, 827833, 827840, 827872, 827877, 827889, 827918, 827943, 827945, 827956, 827975, 828296, 828541, 829933, 831356, 831368, 831370, 831401, 831564, 832871, 832896, 832912, 833293, 833297, 835413, 836270, 836313, 837541, 837547, 843744, 844068, 844142, 844144, 844159, 858487, 868831, 868832, 869003, 871816, 872109, 872114, 872122, 872128, 872128, 872252, 872280, 872284, 872286, 872313, 872319, 872323, 872329, 872332, 872516, 872519, 872520, 872521, 872522, 872523, 872577, 872610, 883965, 883965, 883965, 885331, 889342, 890252, 902145, 905574, 905583, 907124, 907126, 934507, 952585, 952590, 954087, 961548, 962672, 962676, 962681, 962684, 962700, 963513, 963535, 963538, 963558, 964257, 964313, 974961, 979167, 979170, 1000230, 1005197, 1005198, 1006195, 1006788, 1006953, 1006967, 1006968, 1013215, 1013217, 1013218, 1013220, 1013223, 1013328, 1013329, 1013330, 1027704, 1027717, 1027719, 1027733, 1027914, 1030061, 1061981, 1066180, 1066185, 1066201, 1066205, 1066212, 1066245, 1066260, 1066291, 1066297, 1066298, 1066314, 1066824, 1066921, 1066923, 1077634, 1079255, 1079445, 1079508, 1079532, 1079540, 1079544, 1079546, 1080035, 1080495, 1080498, 1098790, 1098790, 1098871, 1098882, 1098982, 1098997, 1099042, 1099043, 1099054, 1099922, 1101949, 1101993, 1101996, 1127428, 1127432, 1127432, 1127433, 1127442, 1127443, 1128057, 1128063, 1128069, 1128072, 1128075, 1128079, 1128102, 1128103, 1128162, 1128165, 1128168, 1128171, 1135879, 1135880, 1148359, 1148364, 1154562, 1156059, 1156839, 1156842, 1163238, 1163272, 1163458, 1163468, 1167539, 1167540, 1169390, 1194146, 1194148, 1194150, 1194152, 1194154, 1194156, 1203042, 1203043, 1227151, 1227161, 1227203, 1227222, 1227240, 1227253, 1227273)
      )"

dat<-sqlQuery(con, qry); head(dat) ##import the queried table

## When finished, close the connection
odbcClose(con)


